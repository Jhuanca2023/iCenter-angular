<main class="min-h-screen bg-white py-4 sm:py-8">
  <!-- Loading state -->
  <div *ngIf="isLoading" class="max-w-6xl w-full px-4 sm:px-6 mx-auto">
    <div class="flex items-center justify-center py-20">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mb-4"></div>
        <p class="text-gray-600">Cargando producto...</p>
      </div>
    </div>
  </div>

  <!-- Error state -->
  <div *ngIf="error && !isLoading" class="max-w-6xl w-full px-4 sm:px-6 mx-auto">
    <div class="text-center py-20">
      <p class="text-red-600 mb-4">{{ error }}</p>
      <a routerLink="/productos" class="text-indigo-500 hover:text-indigo-600">Volver a productos</a>
    </div>
  </div>

  <!-- Product content -->
  <div *ngIf="product && !isLoading && !error" class="max-w-6xl w-full px-4 sm:px-6 mx-auto">
    <p class="text-xs sm:text-sm text-gray-600 mb-4 sm:mb-0" *ngIf="product">
      <a routerLink="/" class="hover:text-indigo-500">Inicio</a> /
      <a routerLink="/productos" class="hover:text-indigo-500"> Productos</a> /
      <span *ngFor="let category of productCategories; let last = last">
        <a *ngIf="!last" [routerLink]="['/productos']" [queryParams]="{ categoria: category }" class="hover:text-indigo-500">{{ category }}</a>
        <span *ngIf="!last"> / </span>
        <span *ngIf="last" class="hover:text-indigo-500">{{ category }}</span>
      </span>
      <span *ngIf="productCategories.length === 0 && productBrand">{{ productBrand }}</span>
      <span *ngIf="productCategories.length > 0 || productBrand"> / </span>
      <span class="text-indigo-500">{{ product.name }}</span>
    </p>

    <div class="flex flex-col md:flex-row md:items-start gap-6 md:gap-16 mt-4">
      <!-- Galería de imágenes -->
      <div class="flex flex-col sm:flex-row items-start gap-3 w-full md:w-1/2">
        <!-- Thumbnails - ocultos en mobile, visibles en desktop -->
        <div class="hidden sm:flex flex-col gap-3 flex-shrink-0">
          <div 
            *ngFor="let img of images" 
            (click)="selectImage(img)"
            [class.border-indigo-500]="selectedImage === img"
            class="border w-20 h-20 sm:w-24 sm:h-24 border-gray-500/30 rounded overflow-hidden cursor-pointer hover:border-indigo-500 transition">
            <img [src]="img" [alt]="'Thumbnail ' + img" class="w-full h-full object-cover">
          </div>
        </div>

        <!-- Imagen principal -->
        <div 
          class="border border-gray-500/30 w-full sm:w-auto rounded overflow-hidden relative image-zoom-container"
          (mousemove)="onImageMouseMove($event)"
          (mouseenter)="onImageMouseEnter()"
          (mouseleave)="onImageMouseLeave()">
          <!-- Badge de descuento -->
          <div *ngIf="hasDiscount" class="absolute top-3 left-3 z-10 bg-red-500 text-white px-3 py-1.5 rounded-full text-sm font-bold shadow-lg">
            -{{ discountPercentage }}%
          </div>
          <img 
            [src]="selectedImage || product.image" 
            [alt]="product.name || 'Producto'" 
            [class.zoomed]="zoomActive"
            [style.transform-origin]="zoomActive ? zoomX + '% ' + zoomY + '%' : 'center'"
            class="product-image w-full h-auto max-w-md max-h-[500px] object-contain">
        </div>

        <!-- Thumbnails móvil - debajo de la imagen principal -->
        <div class="flex sm:hidden gap-2 overflow-x-auto pb-2 -mx-4 px-4">
          <div 
            *ngFor="let img of images" 
            (click)="selectImage(img)"
            [class.border-indigo-500]="selectedImage === img"
            class="border w-16 h-16 flex-shrink-0 border-gray-500/30 rounded overflow-hidden cursor-pointer hover:border-indigo-500 transition">
            <img [src]="img" [alt]="'Thumbnail ' + img" class="w-full h-full object-cover">
          </div>
        </div>
      </div>

      <div class="text-sm w-full md:w-1/2" *ngIf="product">
        <h1 class="text-2xl sm:text-3xl font-medium">{{ product.name }}</h1>

        <div class="flex items-center gap-2 mt-1">
          <div class="flex items-center gap-0.5">
            <button
              *ngFor="let star of getStarsArray(5); let i = index"
              type="button"
              (click)="setRating(i + 1)"
              class="cursor-pointer">
              <svg 
                width="18" 
                height="18" 
                viewBox="0 0 18 17" 
                fill="none" 
                xmlns="http://www.w3.org/2000/svg">
                <path 
                  [attr.fill]="i < userRating ? '#facc15' : '#e5e7eb'"
                  d="M8.049.927c.3-.921 1.603-.921 1.902 0l1.294 3.983a1 1 0 0 0 .951.69h4.188c.969 0 1.371 1.24.588 1.81l-3.388 2.46a1 1 0 0 0-.364 1.118l1.295 3.983c.299.921-.756 1.688-1.54 1.118L9.589 13.63a1 1 0 0 0-1.176 0l-3.389 2.46c-.783.57-1.838-.197-1.539-1.118L4.78 10.99a1 1 0 0 0-.363-1.118L1.028 7.41c-.783-.57-.38-1.81.588-1.81h4.188a1 1 0 0 0 .95-.69z" />
              </svg>
            </button>
          </div>
          <p class="text-sm text-gray-700">
            <span *ngIf="ratingCount > 0">{{ ratingAverage | number:'1.1-1' }} · {{ ratingCount }} reseñas</span>
            <span *ngIf="ratingCount === 0">Sin reseñas</span>
          </p>
        </div>

        <div class="mt-4 sm:mt-6">
          <p *ngIf="hasDiscount" class="text-sm sm:text-base text-gray-500/70 line-through">Precio: ${{ originalPrice | number:'1.2-2' }}</p>
          <p class="text-xl sm:text-2xl font-medium">Precio: ${{ finalPrice | number:'1.2-2' }}</p>
          <span class="text-xs sm:text-sm text-gray-500/70">(incluye todos los impuestos)</span>
        </div>

        <!-- Selector de colores (solo si tiene colores) -->
        <div *ngIf="hasColors" class="mt-6">
          <p class="text-sm font-medium text-gray-900 mb-3">Selecciona el color</p>
          <div class="flex gap-3 flex-wrap">
            <button
              *ngFor="let color of colors"
              type="button"
              (click)="selectColor(color)"
              class="w-6 h-6 rounded-full transition-all hover:scale-110 relative"
              [style.background-color]="color.hex"
              [class.border-2]="selectedColor?.name === color.name"
              [class.border-green-500]="selectedColor?.name === color.name"
              [class.border]="selectedColor?.name !== color.name"
              [class.border-gray-300]="selectedColor?.name !== color.name && color.hex === '#FFFFFF'"
              [class.border-gray-200]="selectedColor?.name !== color.name && color.hex !== '#FFFFFF'"
              [attr.aria-label]="'Color ' + color.name"
              [title]="color.name">
            </button>
          </div>
        </div>

        <p class="text-sm sm:text-base font-medium mt-4 sm:mt-6">Acerca del Producto</p>
        <div class="text-sm sm:text-base text-gray-500/70 mt-2">
          <div [class.line-clamp-3]="!showFullDescription" class="whitespace-pre-line">
            {{ showFullDescription ? (product.description || 'Sin descripción disponible') : shortDescription }}
          </div>
          <button 
            *ngIf="product.description && product.description.length > 150"
            type="button"
            (click)="toggleDescription()"
            class="mt-2 text-indigo-500 hover:text-indigo-600 text-sm font-medium transition">
            {{ showFullDescription ? 'Ver menos' : 'Ver más' }}
          </button>
        </div>
        
        <!-- Información adicional del producto -->
        <div class="mt-4 space-y-2 text-sm text-gray-600">
          <p *ngIf="productBrand"><strong>Marca:</strong> {{ productBrand }}</p>
          <p *ngIf="product.weight"><strong>Peso:</strong> {{ product.weight }}</p>
          <p *ngIf="product.stock !== undefined"><strong>Stock disponible:</strong> {{ product.stock }} unidades</p>
        </div>

        <div class="flex flex-col sm:flex-row items-stretch sm:items-center mt-6 sm:mt-10 gap-3 sm:gap-4 text-sm sm:text-base">
          <button type="button" (click)="addToCart()" class="w-full py-3 sm:py-3.5 font-medium bg-gray-100 text-gray-800/80 hover:bg-gray-200 transition cursor-pointer rounded-lg">
            Agregar al Carrito
          </button>
          <button type="button" (click)="addToCart()" class="w-full py-3 sm:py-3.5 font-medium bg-indigo-500 text-white hover:bg-indigo-600 transition cursor-pointer rounded-lg">
            Comprar Ahora
          </button>
        </div>
      </div>
    </div>

    <!-- Productos relacionados -->
    <div class="mt-8 sm:mt-16 pt-6 sm:pt-8 border-t border-gray-200">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 sm:mb-6">Productos Relacionados</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        <app-product-card *ngFor="let product of relatedProducts" [product]="product" class="h-full"></app-product-card>
      </div>
    </div>
  </div>
</main>
